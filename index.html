<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Studio Noir</title>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

<style>
:root {
  --bg:#000;
  --glass:rgba(255,255,255,.04);
  --glass-border:rgba(255,255,255,.1);
  --text-main:#fff;
  --text-dim:#777;

  --c-piano:#007AFF;
  --c-violin:#FF9500;
  --c-bass:#FF2D55;
  --c-bell:#AF52DE;
  --c-strings:#5AC8FA;
  --c-pad:#34C759;
}

/* ===== BASE ===== */
html,body{
  margin:0;
  height:100%;
  background:black;
  color:white;
  font-family:-apple-system, SF Pro Display, sans-serif;
  overflow:hidden;
  touch-action:none;
  padding-top: env(safe-area-inset-top);
}

/* ===== COMPACT TG HEADER (не ломает логику) ===== */
header{
  position:sticky;
  top:0;
  height:40px;
  display:grid;
  grid-template-columns:auto 1fr auto;
  align-items:center;
  gap:6px;
  padding:4px 8px;
  background:rgba(0,0,0,.65);
  backdrop-filter:blur(18px);
  -webkit-backdrop-filter:blur(18px);
  border-bottom:1px solid rgba(255,255,255,.05);
  z-index:100;
}

.h-left{display:flex;gap:6px;}
.h-center{
  justify-self:center;
  background:rgba(255,255,255,.06);
  padding:5px 14px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}
.h-right{color:#FF3B30;font-size:11px;font-weight:700;cursor:pointer;}

.h-btn{
  width:28px;height:28px;border-radius:50%;border:none;
  background:rgba(255,255,255,.08);color:white;
  display:flex;align-items:center;justify-content:center;
}
.h-btn.play.active{background:white;color:black;}
.h-btn.rec.active{background:#FF3B30;}

/* ===== LAYOUT ===== */
.container{
  height:calc(100vh - 40px);
  display:flex;
  flex-direction:column;
  padding:6px;
  box-sizing:border-box;
}

main{
  flex:1;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* ===== TRACKS (ТВОЙ СТИЛЬ СОХРАНЁН) ===== */
.track-section{
  background:var(--glass);
  border:1px solid var(--glass-border);
  border-radius:16px;
  padding:8px;
}

.track-header{
  font-size:10px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:1px;
  margin-bottom:6px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(16,1fr);
  gap:3px;
}

.step{
  aspect-ratio:1/1.1;
  background:rgba(255,255,255,.03);
  border-radius:6px;
}

/* активные шаги */
.step.active-piano{background:var(--c-piano);}
.step.active-violin{background:var(--c-violin);}
.step.active-bass{background:var(--c-bass);}
.step.active-bell{background:var(--c-bell);}
.step.active-strings{background:var(--c-strings);}
.step.active-pad{background:var(--c-pad);}
.step.active-drum{background:white;}

/* ===== FOOTER ===== */
footer{
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-radius:20px 20px 0 0;
  padding-bottom:env(safe-area-inset-bottom);
}

/* tabs */
.tab-bar{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:4px;
  padding:8px;
}

.tab{
  background:var(--glass);
  border:1px solid var(--glass-border);
  border-radius:10px;
  padding:8px 0;
  text-align:center;
  font-size:9px;
  color:var(--text-dim);
}
.tab.active{background:white;color:black;}

/* sliders */
.sliders{
  display:flex;
  gap:12px;
  padding:0 10px 8px;
}

/* piano */
.piano{
  height:110px;
  display:flex;
  position:relative;
  gap:2px;
  padding:4px;
}
.white{
  flex:1;
  background:linear-gradient(#fff,#ddd);
  border-radius:6px;
}
.black{
  position:absolute;
  background:black;
  width:7%;
  height:55%;
  border-radius:0 0 5px 5px;
}
</style>
</head>

<body>

<header>
  <div class="h-left">
    <button id="p-btn" class="h-btn play" onclick="togglePlay()">▶︎</button>
    <button id="r-btn" class="h-btn rec" onclick="toggleRec()">●</button>
  </div>

  <div class="h-center" id="bpm-ui">120 BPM</div>

  <div class="h-right" onclick="clearAll()">Reset</div>
</header>

<div class="container">

<main id="sequencer-main">
  <div id="melody-tracks"></div>

  <div class="track-section">
    <div class="track-header">Rhythm (K / S / H)</div>
    <div class="grid" id="k-grid"></div>
    <div class="grid" id="s-grid" style="margin-top:4px"></div>
    <div class="grid" id="h-grid" style="margin-top:4px"></div>
  </div>
</main>

<footer>
  <div class="tab-bar">
    <div class="tab active" onclick="setInst('piano',this)">PIANO</div>
    <div class="tab" onclick="setInst('violin',this)">VIOLIN</div>
    <div class="tab" onclick="setInst('bass',this)">BASS</div>
    <div class="tab" onclick="setInst('bell',this)">BELL</div>
    <div class="tab" onclick="setInst('strings',this)">STRINGS</div>
    <div class="tab" onclick="setInst('pad',this)">PAD</div>
  </div>

  <div class="sliders">
    <label>BPM</label>
    <input type="range" min="60" max="180" value="120"
           oninput="changeBPM(this.value)">
    <label>LEN</label>
    <input type="range" id="length-val"
           min="0.1" max="2" step="0.1" value="0.4">
  </div>

  <div class="piano" id="piano-kb"></div>
</footer>
</div>

<script>
/* ========== ТВОЯ РАБОЧАЯ ЛОГИКА (ВОССТАНОВЛЕНА) ========== */

let initialized=false, playing=false, recording=false, currentStep=0;
let selectedInst='piano', lastNote='C4';

const instruments=['piano','violin','bass','bell','strings','pad'];
const melodyData={};
const drumData={k:Array(16).fill(false),
                 s:Array(16).fill(false),
                 h:Array(16).fill(false)};

let synthEngines={}, drumEngines={};

async function init(){
  await Tone.start();

  const masterComp=new Tone.Compressor(-20,4).toDestination();
  const masterLimiter=new Tone.Limiter(-1).connect(masterComp);

  instruments.forEach(inst=>{
    melodyData[inst]=Array(16).fill(null);
    synthEngines[inst]=new Tone.PolySynth(Tone.Synth)
      .connect(masterLimiter);
  });

  drumEngines={
    k:new Tone.MembraneSynth().connect(masterLimiter),
    s:new Tone.NoiseSynth().connect(masterLimiter),
    h:new Tone.MetalSynth().connect(masterLimiter)
  };

  renderTracks();
  renderPiano();

  Tone.Transport.scheduleRepeat(time=>{
    if(drumData.k[currentStep])
      drumEngines.k.triggerAttackRelease("C1","8n",time);

    instruments.forEach(inst=>{
      const noteObj=melodyData[inst][currentStep];
      if(noteObj){
        const dur=document.getElementById('length-val').value;
        let n=noteObj.note;
        if(inst==='bass')
          n=Tone.Frequency(n).transpose(-12).toNote();
        synthEngines[inst].triggerAttackRelease(n,dur,time);
      }
    });

    currentStep=(currentStep+1)%16;
  },"16n");

  initialized=true;
}

function renderTracks(){
  const c=document.getElementById('melody-tracks');

  instruments.forEach(inst=>{
    const sec=document.createElement('div');
    sec.className='track-section';

    const h=document.createElement('div');
    h.className='track-header';
    h.style.color=`var(--c-${inst})`;
    h.textContent=inst.toUpperCase()+" TRACK";

    const g=document.createElement('div');
    g.className='grid';

    for(let i=0;i<16;i++){
      const s=document.createElement('div');
      s.className='step';
      s.onclick=()=>{
        if(melodyData[inst][i]){
          melodyData[inst][i]=null;
          s.className='step';
        }else{
          melodyData[inst][i]={note:lastNote};
          s.classList.add(`active-${inst}`);
        }
      };
      g.appendChild(s);
    }

    sec.appendChild(h);
    sec.appendChild(g);
    c.appendChild(sec);
  });

  ['k','s','h'].forEach(id=>{
    const g=document.getElementById(`${id}-grid`);
    for(let i=0;i<16;i++){
      const s=document.createElement('div');
      s.className='step';
      s.onclick=()=>{
        drumData[id][i]=!drumData[id][i];
        s.classList.toggle('active-drum');
      };
      g.appendChild(s);
    }
  });
}

function renderPiano(){
  const scale=[
   {n:'C4',b:0},{n:'C#4',b:1},{n:'D4',b:0},{n:'D#4',b:1},
   {n:'E4',b:0},{n:'F4',b:0},{n:'F#4',b:1},{n:'G4',b:0},
   {n:'G#4',b:1},{n:'A4',b:0},{n:'A#4',b:1},{n:'B4',b:0},
   {n:'C5',b:0}
  ];

  const kb=document.getElementById('piano-kb');
  let w=0;

  scale.forEach(note=>{
    const k=document.createElement('div');
    k.className=note.b?'black':'white';
    if(note.b) k.style.left=`calc(${(w/8)*100}% - 3.5%)`;
    else w++;

    k.onpointerdown=e=>{
      e.preventDefault();
      lastNote=note.n;

      let n=note.n;
      if(selectedInst==='bass')
        n=Tone.Frequency(n).transpose(-12).toNote();

      synthEngines[selectedInst]
        .triggerAttackRelease(n,"8n");
    };

    kb.appendChild(k);
  });
}

function togglePlay(){
  if(!initialized) init();

  playing=!playing;

  if(playing){
    currentStep=0;
    Tone.Transport.start("+0.05");
    p-btn.textContent="■";
    p-btn.classList.add("active");
  }else{
    Tone.Transport.stop();
    p-btn.textContent="▶︎";
    p-btn.classList.remove("active");
  }
}

function toggleRec(){
  recording=!recording;
  r-btn.classList.toggle("active",recording);
}

function changeBPM(v){
  Tone.Transport.bpm.value=v;
  bpm-ui.textContent=v+" BPM";
}

function clearAll(){
  instruments.forEach(i=>melodyData[i].fill(null));
  Object.keys(drumData).forEach(d=>drumData[d].fill(false));
  document.querySelectorAll('.step')
    .forEach(s=>s.className='step');
}

function setInst(t,el){
  selectedInst=t;
  document.querySelectorAll('.tab')
    .forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
}

init();
</script>
</body>
</html>
