<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Studio Noir Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --surface: #2d2b2a;
            --glass: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #efefef;
            --text-dim: #888;
            
            --out-shadow: 4px 4px 10px rgba(0,0,0,0.5), -2px -2px 8px rgba(255,255,255,0.02);
            --inner-shadow: inset 2px 2px 5px rgba(0,0,0,0.6), inset -1px -1px 3px rgba(255,255,255,0.02);
            
            --c-piano: #007AFF;
            --c-violin: #FF9500;
            --c-bass: #FF2D55;
            --c-bell: #AF52DE;
            --c-strings: #5AC8FA;
            --c-pad: #34C759;
            
            --c-rec: #FF3B30;
            --c-play: #34C759;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden; 
            touch-action: none;
        }

        .container {
            display: flex; flex-direction: column; height: 100vh;
            padding: env(safe-area-inset-top) 12px 0 12px;
        }

        header {
            height: 70px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; border-bottom: 1px solid var(--glass-border);
            margin-bottom: 4px;
        }

        /* Центральная консоль управления */
        .console-hub {
            display: flex; align-items: center; gap: 12px;
            background: #111;
            padding: 6px 14px;
            border-radius: 40px;
            box-shadow: var(--inner-shadow), 0 0 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.03);
        }

        .lcd-display {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 50px; height: 34px;
            background: rgba(0,0,0,0.5);
            border-radius: 6px;
            box-shadow: inset 0 0 8px #000;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .bpm-val {
            font-family: 'Courier New', monospace;
            font-size: 14px; font-weight: bold;
            color: #34C759; text-shadow: 0 0 5px rgba(52, 199, 89, 0.5);
            line-height: 1;
        }
        .bpm-lbl { font-size: 7px; color: #555; text-transform: uppercase; margin-top: 1px; font-weight: 900; }

        .btn-circle {
            width: 36px; height: 36px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(145deg, #3a3837, #262423);
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--out-shadow);
            transition: all 0.2s;
            cursor: pointer;
            color: #999;
        }
        .btn-circle:active { box-shadow: var(--inner-shadow); transform: scale(0.94); }
        .btn-circle svg { width: 18px; height: 18px; fill: currentColor; }

        .btn-circle.play.active-play { color: var(--c-play); border-color: var(--c-play); box-shadow: 0 0 10px rgba(52, 199, 89, 0.2); }
        .btn-circle.rec.active-rec { color: var(--c-rec); border-color: var(--c-rec); box-shadow: 0 0 10px rgba(255, 59, 48, 0.2); }
        .btn-circle.reset:active { color: #fff; }

        main {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            padding: 8px 0 16px; scrollbar-width: none;
        }
        main::-webkit-scrollbar { display: none; }

        .track-card {
            background: var(--glass); border-radius: 14px; padding: 10px;
            border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
            box-shadow: var(--out-shadow);
        }

        .track-info { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .track-label { font-size: 9px; font-weight: 900; letter-spacing: 1.2px; text-transform: uppercase; }

        .step-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 3px; }
        .step {
            aspect-ratio: 1/1.4; background: rgba(0,0,0,0.3); border-radius: 4px;
            box-shadow: var(--inner-shadow); transition: 0.1s;
        }
        .step.playing { border: 1.5px solid #fff; transform: scale(1.05); z-index: 5; }

        .drum-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .drum-name { width: 34px; font-size: 8px; font-weight: 900; color: var(--text-dim); }

        footer {
            background: rgba(30, 30, 30, 0.98);
            border-top: 1px solid var(--glass-border);
            padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -8px 25px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        .tab-bar { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 12px; }
        .tab-item {
            padding: 8px 0; border-radius: 8px; font-size: 8px; font-weight: 800;
            text-align: center; color: var(--text-dim); background: var(--surface);
            box-shadow: var(--out-shadow); border: 1px solid var(--glass-border);
        }
        .tab-item.active { background: #fff; color: #000; box-shadow: var(--inner-shadow); border-color: #fff; }

        .knobs { display: flex; gap: 15px; margin-bottom: 15px; }
        .knob-group { flex: 1; display: flex; align-items: center; gap: 10px; }
        .knob-group label { font-size: 9px; font-weight: 900; color: var(--text-dim); }
        
        input[type=range] { 
            flex: 1; height: 4px; appearance: none; background: rgba(0,0,0,0.4); 
            border-radius: 2px; box-shadow: var(--inner-shadow);
        }
        input[type=range]::-webkit-slider-thumb { 
            appearance: none; width: 20px; height: 20px; border-radius: 50%; 
            background: #fff; box-shadow: var(--out-shadow); border: 4px solid #333;
        }

        .piano-keys { height: 110px; display: flex; position: relative; gap: 3px; }
        .p-white {
            flex: 1; background: linear-gradient(180deg, #fff 0%, #dcdcdc 100%);
            border-radius: 0 0 4px 4px; z-index: 1; box-shadow: var(--out-shadow);
        }
        .p-black {
            position: absolute; background: linear-gradient(180deg, #333 0%, #000 100%);
            width: 7%; height: 55%; z-index: 2; border-radius: 0 0 4px 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .p-white.active { background: #b0b0b0; transform: translateY(1px); box-shadow: var(--inner-shadow); }
        .p-black.active { background: #000; transform: translateY(1px); box-shadow: var(--inner-shadow); }

        .step.active-piano { background: var(--c-piano); box-shadow: 0 0 10px var(--c-piano); }
        .step.active-violin { background: var(--c-violin); box-shadow: 0 0 10px var(--c-violin); }
        .step.active-bass { background: var(--c-bass); box-shadow: 0 0 10px var(--c-bass); }
        .step.active-bell { background: var(--c-bell); box-shadow: 0 0 10px var(--c-bell); }
        .step.active-strings { background: var(--c-strings); box-shadow: 0 0 10px var(--c-strings); }
        .step.active-pad { background: var(--c-pad); box-shadow: 0 0 10px var(--c-pad); }
        .step.active-drum { background: #ffffff; box-shadow: 0 0 10px #ffffff; }
    </style>
</head>
<body>

<div class="container" oncontextmenu="return false;">
    <header>
        <div class="console-hub">
            <!-- Reset -->
            <div class="btn-circle reset" onclick="clearData()">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </div>
            
            <!-- Play -->
            <div id="play-btn" class="btn-circle play" onclick="togglePlay()">
                <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </div>

            <!-- LCD BPM -->
            <div class="lcd-display">
                <span id="bpm-val" class="bpm-val">120</span>
                <span class="bpm-lbl">BPM</span>
            </div>
            
            <!-- Rec -->
            <div id="rec-btn" class="btn-circle rec" onclick="toggleRec()">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/></svg>
            </div>
        </div>
    </header>

    <main id="sequencer"></main>

    <footer>
        <div class="tab-bar" id="instrument-tabs">
            <div class="tab-item active" onclick="changeInst('piano', this)">PIANO</div>
            <div class="tab-item" onclick="changeInst('violin', this)">VIOLIN</div>
            <div class="tab-item" onclick="changeInst('bass', this)">BASS</div>
            <div class="tab-item" onclick="changeInst('bell', this)">BELL</div>
            <div class="tab-item" onclick="changeInst('strings', this)">STRINGS</div>
            <div class="tab-item" onclick="changeInst('pad', this)">PAD</div>
        </div>
        
        <div class="knobs">
            <div class="knob-group">
                <label>BPM</label>
                <input type="range" min="60" max="180" value="120" oninput="updateBPM(this.value)">
            </div>
            <div class="knob-group">
                <label>LEN</label>
                <input type="range" id="note-len" min="0.1" max="1.0" step="0.1" value="0.4">
            </div>
        </div>

        <div class="piano-keys" id="keyboard"></div>
    </footer>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.headerColor = '#1a1a1a';

    document.addEventListener('contextmenu', e => e.preventDefault());

    let audioCtxStarted = false, isPlaying = false, isRecording = false, step = 0;
    let currentInst = 'piano', lastPlayedNote = 'C4';
    
    const instList = ['piano', 'violin', 'bass', 'bell', 'strings', 'pad'];
    const patterns = {}; 
    const drums = { kick: Array(16).fill(false), snare: Array(16).fill(false), hihat: Array(16).fill(false) };
    
    let synths = {}, drumSynths = {};

    async function startAudio() {
        if (audioCtxStarted) return;
        await Tone.start();
        const limiter = new Tone.Limiter(-1).toDestination();

        synths = {
            piano: new Tone.PolySynth(Tone.Synth, { maxPolyphony: 12, oscillator: { type: "amsine" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.8 } }).connect(limiter),
            violin: new Tone.PolySynth(Tone.FMSynth, { maxPolyphony: 8, harmonicity: 3, envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.8 } }).connect(limiter),
            bass: new Tone.PolySynth(Tone.Synth, { maxPolyphony: 4, oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 0.1 } }).connect(limiter),
            bell: new Tone.PolySynth(Tone.FMSynth, { maxPolyphony: 12, harmonicity: 1.5, modulationIndex: 10, envelope: { attack: 0.001, decay: 0.4, sustain: 0, release: 0.8 } }).connect(limiter),
            strings: new Tone.PolySynth(Tone.Synth, { maxPolyphony: 16, oscillator: { type: "sawtooth" }, envelope: { attack: 0.3, decay: 0.1, sustain: 0.6, release: 1 } }).connect(limiter),
            pad: new Tone.PolySynth(Tone.Synth, { maxPolyphony: 16, oscillator: { type: "sine" }, envelope: { attack: 0.8, decay: 0.2, sustain: 0.5, release: 1.5 } }).connect(limiter)
        };

        drumSynths = {
            kick: new Tone.MembraneSynth().connect(limiter),
            snare: new Tone.NoiseSynth({ envelope: { attack: 0.001, decay: 0.1, sustain: 0 } }).connect(limiter),
            hihat: new Tone.MetalSynth({ envelope: { attack: 0.001, decay: 0.05, sustain: 0 } }).connect(limiter)
        };

        Tone.Transport.scheduleRepeat((time) => {
            if (drums.kick[step]) drumSynths.kick.triggerAttackRelease("C1", "16n", time);
            if (drums.snare[step]) drumSynths.snare.triggerAttackRelease("16n", time);
            if (drums.hihat[step]) drumSynths.hihat.triggerAttackRelease("32n", time);

            instList.forEach(name => {
                const n = patterns[name][step];
                if (n) {
                    const dur = document.getElementById('note-len').value;
                    let f = n.note;
                    if(name === 'bass') f = Tone.Frequency(f).transpose(-12).toNote();
                    synths[name].triggerAttackRelease(f, dur, time);
                }
            });

            Tone.Draw.schedule(() => {
                document.querySelectorAll('.step.playing').forEach(el => el.classList.remove('playing'));
                instList.forEach(name => {
                    const grid = document.getElementById(`grid-${name}`);
                    if(grid && grid.children[step]) grid.children[step].classList.add('playing');
                });
                ['kick','snare','hihat'].forEach(d => {
                    const row = document.getElementById(`grid-${d}`);
                    if(row && row.children[step]) row.children[step].classList.add('playing');
                });
            }, time);

            step = (step + 1) % 16;
        }, "16n");

        audioCtxStarted = true;
    }

    function buildUI() {
        const main = document.getElementById('sequencer');
        instList.forEach(name => {
            patterns[name] = Array(16).fill(null);
            const card = document.createElement('div');
            card.className = 'track-card';
            card.innerHTML = `
                <div class="track-info"><span class="track-label" style="color:var(--c-${name})">${name}</span></div>
                <div class="step-grid" id="grid-${name}"></div>
            `;
            const grid = card.querySelector('.step-grid');
            for(let i=0; i<16; i++) {
                const s = document.createElement('div');
                s.className = 'step';
                s.onclick = (e) => {
                    e.preventDefault();
                    startAudio();
                    if(patterns[name][i]) { patterns[name][i] = null; s.className = 'step'; } 
                    else { patterns[name][i] = { note: lastPlayedNote }; s.classList.add(`active-${name}`); }
                };
                grid.appendChild(s);
            }
            main.appendChild(card);
        });

        const dCard = document.createElement('div');
        dCard.className = 'track-card';
        dCard.innerHTML = `<div class="track-info"><span class="track-label">Drum Kit</span></div>`;
        ['kick', 'snare', 'hihat'].forEach(d => {
            const row = document.createElement('div');
            row.className = 'drum-row';
            row.innerHTML = `<span class="drum-name">${d.toUpperCase()}</span><div class="step-grid" id="grid-${d}" style="flex:1"></div>`;
            const grid = row.querySelector('.step-grid');
            for(let i=0; i<16; i++) {
                const s = document.createElement('div');
                s.className = 'step';
                s.onclick = (e) => { e.preventDefault(); startAudio(); drums[d][i] = !drums[d][i]; s.classList.toggle('active-drum'); };
                grid.appendChild(s);
            }
            dCard.appendChild(row);
        });
        main.appendChild(dCard);

        const kb = document.getElementById('keyboard');
        const scale = [{n:'C4',b:0},{n:'C#4',b:1},{n:'D4',b:0},{n:'D#4',b:1},{n:'E4',b:0},{n:'F4',b:0},{n:'F#4',b:1},{n:'G4',b:0},{n:'G#4',b:1},{n:'A4',b:0},{n:'A#4',b:1},{n:'B4',b:0},{n:'C5',b:0}];
        let whites = 0;
        scale.forEach(note => {
            const key = document.createElement('div');
            key.className = note.b ? 'p-black' : 'p-white';
            if(note.b) key.style.left = `calc(${(whites/8)*100}% - 3.5%)`; else whites++;
            
            const handleDown = (e) => {
                e.preventDefault();
                startAudio();
                lastPlayedNote = note.n;
                let f = note.n; if(currentInst === 'bass') f = Tone.Frequency(f).transpose(-12).toNote();
                synths[currentInst].triggerAttack(f);
                key.classList.add('active');
                if(isRecording && isPlaying) {
                    patterns[currentInst][step] = { note: note.n };
                    const cell = document.getElementById(`grid-${currentInst}`).children[step];
                    cell.className = `step active-${currentInst}`;
                }
            };
            const handleUp = (e) => { 
                e.preventDefault();
                if(synths[currentInst]) {
                    let f = lastPlayedNote; if(currentInst === 'bass') f = Tone.Frequency(f).transpose(-12).toNote();
                    synths[currentInst].triggerRelease(f); 
                }
                key.classList.remove('active'); 
            };
            key.addEventListener('pointerdown', handleDown);
            key.addEventListener('pointerup', handleUp);
            key.addEventListener('pointerleave', handleUp);
            key.addEventListener('touchstart', (e) => e.preventDefault(), {passive: false});
            kb.appendChild(key);
        });
    }

    function togglePlay() {
        startAudio().then(() => {
            isPlaying = !isPlaying;
            const btn = document.getElementById('play-btn');
            const icon = document.getElementById('play-icon');
            if(isPlaying) { 
                step = 0; 
                Tone.Transport.start(); 
                icon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'; // Stop
                btn.classList.add('active-play');
            } else { 
                Tone.Transport.stop(); 
                instList.forEach(i => { if(synths[i]) synths[i].releaseAll(); });
                icon.innerHTML = '<path d="M8 5v14l11-7z"/>'; // Play
                btn.classList.remove('active-play');
            }
        });
    }

    function toggleRec() { if(!isPlaying) togglePlay(); isRecording = !isRecording; document.getElementById('rec-btn').classList.toggle('active-rec', isRecording); }
    
    function changeInst(name, el) { 
        if(synths[currentInst]) synths[currentInst].releaseAll();
        currentInst = name;
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }

    function updateBPM(v) { 
        Tone.Transport.bpm.value = v; 
        document.getElementById('bpm-val').innerText = v; 
    }

    function clearData() {
        instList.forEach(n => {
            patterns[n].fill(null);
            const g = document.getElementById(`grid-${n}`);
            if(g) [...g.children].forEach(c => c.className = 'step');
        });
        ['kick','snare','hihat'].forEach(d => {
            drums[d].fill(false);
            const g = document.getElementById(`grid-${d}`);
            if(g) [...g.children].forEach(c => c.className = 'step');
        });
    }

    buildUI();
</script>
</body>
</html>

