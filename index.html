<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Studio Noir</title>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
<style>
:root{
--bg:#000;
--glass:rgba(255,255,255,.04);
--glass-border:rgba(255,255,255,.1);
--c-piano:#007AFF;
--c-violin:#FF9500;
--c-bass:#FF2D55;
--c-bell:#AF52DE;
--c-strings:#5AC8FA;
--c-pad:#34C759;
}
body,html{margin:0;background:#000;color:#fff;font-family:-apple-system,sans-serif;height:100vh;}
#splash{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;}
.start-btn{padding:16px 40px;border-radius:30px;border:none;font-weight:700;cursor:pointer;}
.container{padding:10px;height:100vh;box-sizing:border-box;display:flex;flex-direction:column;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.btn{padding:10px 18px;border:1px solid var(--glass-border);background:var(--glass);color:#fff;border-radius:12px;}
.btn-play.active{background:#fff;color:#000;}
.btn-rec.active{background:#FF3B30;}
.lcd{background:var(--glass);padding:8px 14px;border-radius:12px;}
main{flex:1;overflow-y:auto;}
.track-section{background:var(--glass);border:1px solid var(--glass-border);border-radius:18px;padding:10px;margin-bottom:8px;}
.grid{display:grid;grid-template-columns:repeat(16,1fr);gap:3px;}
.step{aspect-ratio:1/1.1;background:rgba(255,255,255,.03);border-radius:5px;}
.step.active-piano{background:var(--c-piano);}
.step.active-violin{background:var(--c-violin);}
.step.active-bass{background:var(--c-bass);}
.step.active-bell{background:var(--c-bell);}
.step.active-strings{background:var(--c-strings);}
.step.active-pad{background:var(--c-pad);}
.step.active-drum{background:#fff;}
footer{background:#000;border-radius:24px 24px 0 0;}
.tab-bar{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;padding:10px;}
.tab{background:var(--glass);border:1px solid var(--glass-border);padding:10px;text-align:center;border-radius:10px;}
.tab.active{background:#fff;color:#000;}
.piano{height:140px;display:flex;position:relative;padding:4px;gap:2px;}
.white{flex:1;background:#fff;border-radius:6px;}
.black{position:absolute;background:#000;width:7%;height:55%;border-radius:0 0 5px 5px;}
</style>
</head>

<body>

<div id="splash">
<h2>STUDIO NOIR</h2>
<button class="start-btn" onclick="init()">ВОЙТИ В СТУДИЮ</button>
</div>

<div class="container">
<header>
<div>
<button id="p-btn" class="btn" onclick="togglePlay()">Play</button>
<button id="r-btn" class="btn" onclick="toggleRec()">Rec</button>
</div>
<div class="lcd" id="bpm-ui">120 BPM</div>
<div style="color:red;cursor:pointer" onclick="clearAll()">RESET</div>
</header>

<main>
<div id="melody-tracks"></div>

<div class="track-section">
<div>Rhythm</div>
<div class="grid" id="k-grid"></div>
<div class="grid" id="s-grid" style="margin-top:4px"></div>
<div class="grid" id="h-grid" style="margin-top:4px"></div>
</div>
</main>

<footer>
<div class="tab-bar">
<div class="tab active" onclick="setInst('piano',this)">PIANO</div>
<div class="tab" onclick="setInst('violin',this)">VIOLIN</div>
<div class="tab" onclick="setInst('bass',this)">BASS</div>
<div class="tab" onclick="setInst('bell',this)">BELL</div>
<div class="tab" onclick="setInst('strings',this)">STRINGS</div>
<div class="tab" onclick="setInst('pad',this)">PAD</div>
</div>

<div style="padding:0 15px 10px;display:flex;gap:10px;align-items:center;">
<label>BPM</label>
<input type="range" min="60" max="180" value="120" oninput="changeBPM(this.value)">
<label>LEN</label>
<input id="length-val" type="range" min="0.1" max="2" step="0.1" value="0.4">
</div>

<div class="piano" id="piano-kb"></div>
</footer>
</div>

<script>
let initialized=false,playing=false,recording=false,currentStep=0;
let selectedInst="piano",lastNote="C4";

const instruments=["piano","violin","bass","bell","strings","pad"];
const melodyData={};
const drumData={k:Array(16).fill(false),s:Array(16).fill(false),h:Array(16).fill(false)};
let synthEngines={}, drumEngines={};

async function init(){
await Tone.start();
document.getElementById("splash").style.display="none";

const masterComp=new Tone.Compressor(-20,4).toDestination();
const masterLimiter=new Tone.Limiter(-1).connect(masterComp);

instruments.forEach(inst=>{
melodyData[inst]=Array(16).fill(null);

let synth;

if(inst==="piano"){
synth=new Tone.PolySynth(Tone.Synth,{
oscillator:{type:"triangle"},
envelope:{attack:0.01,decay:0.3,sustain:0.4,release:1.2}
});
}

if(inst==="violin"){
synth=new Tone.PolySynth(Tone.Synth,{
oscillator:{type:"sawtooth"},
envelope:{attack:0.2,decay:0.1,sustain:0.8,release:0.8}
});
}

if(inst==="bass"){
synth=new Tone.MonoSynth({
oscillator:{type:"square"},
filter:{Q:3,type:"lowpass",frequency:120},
envelope:{attack:0.01,decay:0.2,sustain:0.5,release:0.6}
});
}

if(inst==="bell"){
synth=new Tone.PolySynth(Tone.FMSynth,{
harmonicity:8,
modulationIndex:2,
envelope:{attack:0.001,decay:1.2,sustain:0,release:1.5},
modulation:{type:"sine"}
});
}

if(inst==="strings"){
synth=new Tone.PolySynth(Tone.Synth,{
oscillator:{type:"sawtooth"},
envelope:{attack:0.4,decay:0.2,sustain:0.9,release:1.4}
});
}

if(inst==="pad"){
synth=new Tone.PolySynth(Tone.Synth,{
oscillator:{type:"sine"},
envelope:{attack:1.2,decay:0.5,sustain:0.8,release:2}
});
}

synthEngines[inst]=synth.connect(masterLimiter);
});

drumEngines={
k:new Tone.MembraneSynth({volume:3}).connect(masterLimiter),
s:new Tone.NoiseSynth({volume:-5}).connect(masterLimiter),
h:new Tone.MetalSynth({volume:-18}).connect(masterLimiter)
};

renderTracks();
renderPiano();

Tone.Transport.scheduleRepeat(time=>{
if(drumData.k[currentStep]) drumEngines.k.triggerAttackRelease("C1","8n",time);
if(drumData.s[currentStep]) drumEngines.s.triggerAttackRelease("16n",time);
if(drumData.h[currentStep]) drumEngines.h.triggerAttackRelease("32n",time);

instruments.forEach(inst=>{
const n=melodyData[inst][currentStep];
if(n){
const dur=document.getElementById("length-val").value;
let freq=n.note;
if(inst==="bass") freq=Tone.Frequency(freq).transpose(-12).toNote();
synthEngines[inst].triggerAttackRelease(freq,dur,time);
}
});
currentStep=(currentStep+1)%16;
},"16n");

initialized=true;
}

function renderTracks(){
const c=document.getElementById("melody-tracks");
instruments.forEach(inst=>{
const s=document.createElement("div");
s.className="track-section";
const g=document.createElement("div");
g.className="grid"; g.id=`grid-${inst}`;

for(let i=0;i<16;i++){
const cell=document.createElement("div");
cell.className="step";
cell.onclick=()=>{
if(melodyData[inst][i]){
melodyData[inst][i]=null;
cell.className="step";
}else{
melodyData[inst][i]={note:lastNote};
cell.className=`step active-${inst}`;
}
};
g.appendChild(cell);
}
s.appendChild(g);
c.appendChild(s);
});

["k","s","h"].forEach(id=>{
const g=document.getElementById(id+"-grid");
for(let i=0;i<16;i++){
const c=document.createElement("div");
c.className="step";
c.onclick=()=>{
drumData[id][i]=!drumData[id][i];
c.classList.toggle("active-drum");
};
g.appendChild(c);
}
});
}

function renderPiano(){
const scale=["C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5"];
const kb=document.getElementById("piano-kb");

scale.forEach(n=>{
const k=document.createElement("div");
k.className=n.includes("#")?"black":"white";

k.onpointerdown=e=>{
e.preventDefault();
lastNote=n;
let freq=n;
if(selectedInst==="bass") freq=Tone.Frequency(n).transpose(-12).toNote();
synthEngines[selectedInst].triggerAttack(freq);

if(recording && playing){
melodyData[selectedInst][currentStep]={note:n};
const cell=document.getElementById(`grid-${selectedInst}`).children[currentStep];
cell.className=`step active-${selectedInst}`;
}
};

k.onpointerup=k.onpointerleave=()=>{
let freq=n;
if(selectedInst==="bass") freq=Tone.Frequency(n).transpose(-12).toNote();
synthEngines[selectedInst].triggerRelease(freq);
};

kb.appendChild(k);
});
}

function togglePlay(){
if(!initialized) return;
playing=!playing;
if(playing){
currentStep=0;
Tone.Transport.start("+0.05");
}else{
Tone.Transport.stop();
}
document.getElementById("p-btn").classList.toggle("active",playing);
document.getElementById("p-btn").innerText=playing?"Stop":"Play";
}

function toggleRec(){
if(!playing) togglePlay();
recording=!recording;
document.getElementById("r-btn").classList.toggle("active",recording);
}

function setInst(t,el){
selectedInst=t;
document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
el.classList.add("active");
}

function changeBPM(v){
Tone.Transport.bpm.value=v;
document.getElementById("bpm-ui").innerText=v+" BPM";
}

function clearAll(){
instruments.forEach(i=>melodyData[i].fill(null));
Object.keys(drumData).forEach(k=>drumData[k].fill(false));
document.querySelectorAll(".step").forEach(s=>s.className="step");
}
</script>
</body>
</html>
