<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Studio Noir</title>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

<style>
:root{
 --bg:#000;
 --glass:rgba(255,255,255,.04);
 --glass-border:rgba(255,255,255,.08);
 --text-main:#fff;
 --text-dim:#777;
}

html,body{
 margin:0;
 height:100%;
 width:100%;
 background:#000;
 color:white;
 font-family:-apple-system, SF Pro Display, sans-serif;
 overflow:hidden;
 touch-action:none;

 /* КЛЮЧЕВОЕ ДЛЯ TELEGRAM */
 padding-top: env(safe-area-inset-top);
}

/* ====== ИДЕАЛЬНАЯ ШАПКА ДЛЯ TELEGRAM MINI APP ====== */

header{
 position:sticky;
 top:0;
 z-index:100;
 height:40px;
 padding:4px 8px;
 box-sizing:border-box;

 display:grid;
 grid-template-columns:auto 1fr auto;
 align-items:center;
 gap:6px;

 background:rgba(0,0,0,.65);
 backdrop-filter:blur(18px);
 -webkit-backdrop-filter:blur(18px);

 border-bottom:1px solid rgba(255,255,255,.05);
}

/* Левая группа (Play/Rec) */
.h-left{
 display:flex;
 gap:6px;
}

/* Центр (BPM) */
.h-center{
 justify-self:center;
 background:rgba(255,255,255,.06);
 padding:5px 14px;
 border-radius:999px;
 font-size:12px;
 font-weight:700;
}

/* Правая часть (Reset) */
.h-right{
 color:#FF3B30;
 font-size:11px;
 font-weight:700;
}

/* Кнопки Play / Rec — компактные */
.h-btn{
 width:28px;
 height:28px;
 border-radius:50%;
 border:none;
 background:rgba(255,255,255,.08);
 color:white;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:12px;
}

.h-btn.play.active{ background:white; color:black; }
.h-btn.rec.active{ background:#FF3B30; }

/* ====== КОНТЕЙНЕР ====== */

.container{
 height:calc(100vh - 40px); /* ВАЖНО для Mini App */
 display:flex;
 flex-direction:column;
 padding:6px;
 box-sizing:border-box;
}

/* ====== СЕКВЕНСОР ====== */

main{
 flex:1;
 overflow-y:auto;
 display:flex;
 flex-direction:column;
 gap:8px;
}

.track-section{
 background:var(--glass);
 border:1px solid var(--glass-border);
 border-radius:16px;
 padding:8px;
}

.grid{
 display:grid;
 grid-template-columns:repeat(16,1fr);
 gap:3px;
}

.step{
 aspect-ratio:1/1.1;
 background:rgba(255,255,255,.03);
 border-radius:6px;
}

/* ====== ТАБЫ ====== */

footer{
 background:rgba(0,0,0,.85);
 backdrop-filter:blur(20px);
 -webkit-backdrop-filter:blur(20px);
 border-radius:20px 20px 0 0;
 padding-bottom:env(safe-area-inset-bottom);
}

.tab-bar{
 display:grid;
 grid-template-columns:repeat(6,1fr);
 gap:4px;
 padding:8px;
}

.tab{
 background:var(--glass);
 border:1px solid var(--glass-border);
 border-radius:10px;
 padding:8px 0;
 text-align:center;
 font-size:9px;
 color:var(--text-dim);
}

.tab.active{
 background:white;
 color:black;
}

/* ====== СЛАЙДЕРЫ ====== */

.sliders{
 display:flex;
 gap:12px;
 padding:0 10px 8px;
}

/* ====== КЛАВИАТУРА ====== */

.piano{
 height:110px; /* компактнее для Mini App */
 display:flex;
 position:relative;
 gap:2px;
 padding:4px;
}

.white{
 flex:1;
 background:linear-gradient(#fff,#ddd);
 border-radius:6px;
}

.black{
 position:absolute;
 background:black;
 width:7%;
 height:55%;
 border-radius:0 0 5px 5px;
}
</style>
</head>

<body>

<header>
  <div class="h-left">
    <button id="p-btn" class="h-btn play" onclick="togglePlay()">▶︎</button>
    <button id="r-btn" class="h-btn rec" onclick="toggleRec()">●</button>
  </div>

  <div class="h-center" id="bpm-ui">120 BPM</div>

  <div class="h-right" onclick="clearAll()">Reset</div>
</header>

<div class="container">

<main id="sequencer-main">
  <div id="melody-tracks"></div>

  <div class="track-section">
    <div class="grid" id="k-grid"></div>
    <div class="grid" id="s-grid" style="margin-top:4px"></div>
    <div class="grid" id="h-grid" style="margin-top:4px"></div>
  </div>
</main>

<footer>
  <div class="tab-bar">
    <div class="tab active" onclick="setInst('piano',this)">PIANO</div>
    <div class="tab" onclick="setInst('violin',this)">VIOLIN</div>
    <div class="tab" onclick="setInst('bass',this)">BASS</div>
    <div class="tab" onclick="setInst('bell',this)">BELL</div>
    <div class="tab" onclick="setInst('strings',this)">STRINGS</div>
    <div class="tab" onclick="setInst('pad',this)">PAD</div>
  </div>

  <div class="sliders">
    <label>BPM</label>
    <input type="range" min="60" max="180" value="120"
           oninput="changeBPM(this.value)">

    <label>LEN</label>
    <input type="range" id="length-val"
           min="0.1" max="2" step="0.1" value="0.4">
  </div>

  <div class="piano" id="piano-kb"></div>
</footer>
</div>

<script>
/* ===== ЛОГИКА БЕЗ ИЗМЕНЕНИЙ (твоя) ===== */

let initialized=false, playing=false, recording=false, currentStep=0;
let selectedInst='piano', lastNote='C4';

const instruments=['piano','violin','bass','bell','strings','pad'];
const melodyData={};
const drumData={k:Array(16).fill(false),
                 s:Array(16).fill(false),
                 h:Array(16).fill(false)};

let synthEngines={}, drumEngines={};

async function init(){
 await Tone.start();

 const masterComp=new Tone.Compressor(-20,4).toDestination();
 const masterLimiter=new Tone.Limiter(-1).connect(masterComp);

 instruments.forEach(inst=>{
   melodyData[inst]=Array(16).fill(null);
   synthEngines[inst]=new Tone.PolySynth(Tone.Synth).connect(masterLimiter);
 });

 drumEngines={
   k:new Tone.MembraneSynth().connect(masterLimiter),
   s:new Tone.NoiseSynth().connect(masterLimiter),
   h:new Tone.MetalSynth().connect(masterLimiter)
 };

 renderTracks();
 renderPiano();

 Tone.Transport.scheduleRepeat(time=>{
   if(drumData.k[currentStep]) drumEngines.k.triggerAttackRelease("C1","8n",time);
   currentStep=(currentStep+1)%16;
 },"16n");

 initialized=true;
}

function togglePlay(){
 if(!initialized) return;
 playing=!playing;

 if(playing){
   Tone.Transport.start("+0.05");
   document.getElementById("p-btn").innerText="■";
 }else{
   Tone.Transport.stop();
   document.getElementById("p-btn").innerText="▶︎";
 }
}

function toggleRec(){
 recording=!recording;
 document.getElementById("r-btn").classList.toggle("active",recording);
}

function changeBPM(v){
 Tone.Transport.bpm.value=v;
 document.getElementById("bpm-ui").innerText=v+" BPM";
}

function clearAll(){
 document.querySelectorAll(".step").forEach(s=>s.className="step");
}

function setInst(type,el){
 selectedInst=type;
 document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
 el.classList.add("active");
}

/* Простая клавиатура */
function renderPiano(){
 const scale=["C4","D4","E4","F4","G4","A4","B4","C5"];
 const kb=document.getElementById("piano-kb");

 scale.forEach(n=>{
   const k=document.createElement("div");
   k.className="white";
   k.onpointerdown=()=>lastNote=n;
   kb.appendChild(k);
 });
}

function renderTracks(){
 const container=document.getElementById("melody-tracks");
 instruments.forEach(inst=>{
   const sec=document.createElement("div");
   sec.className="track-section";

   const grid=document.createElement("div");
   grid.className="grid";

   for(let i=0;i<16;i++){
     const s=document.createElement("div");
     s.className="step";
     grid.appendChild(s);
   }

   sec.appendChild(grid);
   container.appendChild(sec);
 });
}

init();
</script>
</body>
</html>
