<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, height=device-height,
               initial-scale=1.0, maximum-scale=1.0,
               user-scalable=no, viewport-fit=cover">

<title>Studio Noir</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>

<style>
:root{
  --bg:#000;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --accent:#0A84FF;
  --accent-glow:rgba(10,132,255,.45);
  --danger:#FF453A;
  --text:#fff;
  --dim:#8E8E93;
}

html,body{
  margin:0;
  background:linear-gradient(180deg,#000,#050505);
  color:var(--text);
  font-family:-apple-system, SF Pro Display, system-ui, sans-serif;
  height:100%;
  overflow:hidden;
  touch-action:manipulation;
}

/* ---- SPLASH ---- */
#splash{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:16px;
  z-index:999;
}
#splash button{
  padding:16px 48px;
  border-radius:24px;
  border:0;
  font-weight:700;
}

/* ---- LAYOUT ---- */
.app{
  height:100vh;
  padding:
    env(safe-area-inset-top)
    8px
    env(safe-area-inset-bottom)
    8px;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* ---- HEADER ---- */
.topbar{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  align-items:center;
  height:56px;
}

.btn-glass{
  background:var(--card);
  border:1px solid var(--border);
  backdrop-filter:blur(12px);
  color:white;
  border-radius:14px;
  padding:8px 12px;
  font-weight:700;
}

.center-pill{
  background:var(--card);
  border-radius:16px;
  padding:8px 14px;
  font-weight:700;
}

/* ---- TABS ---- */
.tabs-wrap{
  overflow-x:auto;
  white-space:nowrap;
  padding:6px 0;
}
.tabs{
  display:inline-flex;
  gap:8px;
}
.tab{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:10px 14px;
  font-size:11px;
  font-weight:800;
  color:var(--dim);
}
.tab.active{
  background:var(--accent);
  color:white;
  box-shadow:0 0 14px var(--accent-glow);
}

/* ---- GLASS CARD ---- */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:20px;
  padding:12px;
  flex:1;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.row-label{
  font-size:10px;
  font-weight:800;
  color:var(--dim);
  letter-spacing:.5px;
}

/* 16 circles */
.grid{
  display:grid;
  grid-template-columns:repeat(16,1fr);
  gap:6px;
}
.step{
  aspect-ratio:1/1;
  border-radius:50%;
  background:rgba(255,255,255,.06);
}
.step.active-m{ background:var(--accent); }
.step.active-d{ background:white; }
.step.playing{
  outline:2px solid white;
  transform:scale(1.1);
}

/* ---- SLIDERS ---- */
.sliders{
  display:flex;
  gap:12px;
  align-items:center;
}
input[type=range]{
  -webkit-appearance:none;
  flex:1;
  height:6px;
  border-radius:3px;
  background:var(--border);
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:18px;
  height:18px;
  border-radius:50%;
  background:white;
}

/* ---- PIANO ---- */
.piano{
  height:140px;
  display:flex;
  position:relative;
  gap:2px;
}
.white{
  flex:1;
  background:linear-gradient(180deg,#fff,#e0e0e0);
  border-radius:10px;
}
.black{
  position:absolute;
  background:#000;
  width:6%;
  height:58%;
  border-radius:0 0 8px 8px;
}
.white.pressed{ transform:translateY(2px); }
.black.pressed{ transform:translateY(2px); }
</style>
</head>

<body>

<div id="splash">
  <h1 style="font-weight:300">Studio Noir</h1>
  <button onclick="boot()">ЗАПУСТИТЬ</button>
</div>

<div class="app">

<div class="topbar">
  <div>
    <button class="btn-glass" onclick="Telegram.WebApp.close()">◀ Закрыть</button>
  </div>

  <div class="center-pill" id="bpm-val">120 BPM</div>

  <div style="text-align:right">
    <button class="btn-glass" onclick="savePattern()">✓ Сохранить</button>
  </div>
</div>

<div class="tabs-wrap">
  <div class="tabs">
    <div class="tab active" onclick="switchInst('piano',this)">PIANO</div>
    <div class="tab" onclick="switchInst('bass',this)">BASS</div>
    <div class="tab" onclick="switchInst('strings',this)">STRINGS</div>
    <div class="tab" onclick="switchInst('pad',this)">PAD</div>
    <div class="tab" onclick="switchInst('bell',this)">BELL</div>
  </div>
</div>

<div class="card">
  <div class="row-label">MELODY FLOW</div>
  <div class="grid" id="melody-grid"></div>

  <div class="row-label">BEAT PADS</div>
  <div class="grid" id="k-grid"></div>
  <div class="grid" id="s-grid"></div>
  <div class="grid" id="h-grid"></div>
</div>

<div class="sliders">
  <label>BPM</label>
  <input type="range" min="60" max="180" value="120"
         oninput="setTempo(this.value)">
  <label>REL</label>
  <input type="range" id="release-val"
         min="0.1" max="2" step="0.1" value="0.4">
</div>

<div class="piano" id="piano-keys"></div>

</div>

<script>
Telegram.WebApp.ready();
Telegram.WebApp.expand();

let isLive=false,isPlaying=false,isRecording=false,currentStep=0;
let activeInstrument='piano', lastPlayedNote='C4';

const drumData={k:Array(16).fill(false),
                s:Array(16).fill(false),
                h:Array(16).fill(false)};
const melodyData=Array(16).fill(null);
let instruments={}, percussion={};

async function boot(){
  await Tone.start();
  splash.style.display='none';

  const limiter = new Tone.Limiter(-1).toDestination();

  /* ====== РАЗНЫЕ ЗВУКИ СИНТЕЗАТОРОВ ====== */
  instruments = {

    // PIANO — мягкий, короткий, перкуссивный
    piano: new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: "triangle" },
      envelope: {
        attack: 0.01,
        decay: 0.2,
        sustain: 0.2,
        release: 0.6
      }
    }).connect(limiter),

    // BASS — жирный саб
    bass: new Tone.MonoSynth({
      oscillator: { type: "square" },
      filter: { Q: 2, type: "lowpass", frequency: 200 },
      envelope: {
        attack: 0.01,
        decay: 0.3,
        sustain: 0.5,
        release: 0.3
      }
    }).connect(limiter),

    // STRINGS — оркестровые, плавные
    strings: new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: "sawtooth" },
      envelope: {
        attack: 0.6,
        decay: 0.3,
        sustain: 0.7,
        release: 1.5
      }
    }).connect(limiter),

    // PAD — воздушный эмбиент
    pad: new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: "sine" },
      envelope: {
        attack: 1.2,
        decay: 0.4,
        sustain: 0.8,
        release: 2.2
      }
    }).connect(limiter),

    // BELL — металлический звон
    bell: new Tone.PolySynth(Tone.FMSynth, {
      harmonicity: 3,
      modulationIndex: 12,
      envelope: {
        attack: 0.01,
        decay: 0.2,
        sustain: 0.1,
        release: 0.8
      }
    }).connect(limiter)
  };

  percussion={
    k:new Tone.MembraneSynth().connect(limiter),
    s:new Tone.NoiseSynth().connect(limiter),
    h:new Tone.MetalSynth().connect(limiter)
  };

  renderInterface();

  Tone.Transport.scheduleRepeat((time)=>{
    if(drumData.k[currentStep])
      percussion.k.triggerAttackRelease("C1","8n",time);
    if(drumData.s[currentStep])
      percussion.s.triggerAttackRelease("16n",time);
    if(drumData.h[currentStep])
      percussion.h.triggerAttackRelease("32n",time);

    const mel=melodyData[currentStep];
    if(mel){
      const rel=document.getElementById('release-val').value;
      instruments[mel.type]
        .triggerAttackRelease(mel.note,rel,time);
    }

    document.querySelectorAll('.step')
      .forEach(s=>s.classList.remove('playing'));

    ['melody','k','s','h'].forEach(id=>{
      const el=document.getElementById(id+'-grid')
        .children[currentStep];
      if(el) el.classList.add('playing');
    });

    currentStep=(currentStep+1)%16;
  },"16n");

  isLive=true;
}

/* ---- RENDER UI ---- */
function renderInterface(){
  const m=document.getElementById('melody-grid');
  for(let i=0;i<16;i++){
    const s=document.createElement('div');
    s.className='step';
    s.onclick=()=>{
      if(melodyData[i]){
        melodyData[i]=null;
        s.classList.remove('active-m');
      } else {
        melodyData[i]={note:lastPlayedNote,type:activeInstrument};
        s.classList.add('active-m');
      }
    };
    m.appendChild(s);
  }

  ['k','s','h'].forEach(id=>{
    const g=document.getElementById(id+'-grid');
    for(let i=0;i<16;i++){
      const s=document.createElement('div');
      s.className='step';
      s.onclick=()=>{
        drumData[id][i]=!drumData[id][i];
        s.classList.toggle('active-d');
      };
      g.appendChild(s);
    }
  });

  const scale=[
   'C4','C#4','D4','D#4','E4','F4','F#4',
   'G4','G#4','A4','A#4','B4','C5'
  ];

  const piano=document.getElementById('piano-keys');
  let whites=0;

  scale.forEach(n=>{
    const isBlack=n.includes('#');
    const k=document.createElement('div');
    k.className=isBlack?'black':'white';

    if(isBlack)
      k.style.left=`calc(${(whites/8)*100}% - 3%)`;
    else whites++;

    const play=e=>{
      e.preventDefault();
      lastPlayedNote=n;
      instruments[activeInstrument]?.triggerAttack(n);
      k.classList.add('pressed');

      if(isRecording && isPlaying){
        melodyData[currentStep]={note:n,type:activeInstrument};
        document.getElementById('melody-grid')
          .children[currentStep]
          .classList.add('active-m');
      }
    };

    const stop=()=>{
      instruments[activeInstrument]?.triggerRelease(n);
      k.classList.remove('pressed');
    };

    k.onpointerdown=play;
    k.onpointerup=stop;
    k.onpointerleave=stop;

    piano.appendChild(k);
  });
}

/* ---- CONTROLS ---- */
function switchInst(t,el){
  activeInstrument=t;
  document.querySelectorAll('.tab')
    .forEach(x=>x.classList.remove('active'));
  el.classList.add('active');
}

function setTempo(v){
  Tone.Transport.bpm.value=v;
  bpm_val.innerText=v+' BPM';
}

function savePattern(){
  Telegram.WebApp.showAlert("Сохранено (заглушка)");
}
</script>

</body>
</html>
